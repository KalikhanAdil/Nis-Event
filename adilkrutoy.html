<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Портал мероприятий — Олимпиады, Хакатоны, Стартапы</title>
  <style>
    /* =========================
       Design variables & reset
       ========================= */
    .credits{
    position: fixed;
    left: 14px;
    bottom: 10px;
    font-size: 11px;
    opacity: 0.65;
    color: var(--muted);
    pointer-events: none;
}
    :root{
      --accent: #65c466;               /* основной салатово-зелёный (меняется в настройках) */
      --accent-600: #4aa64a;
      --accent-rgba: 101,196,102;     /* rgb triple for computed rgba usage */
      --muted: #6b7280;
      --bg: #f5f7fb;
      --card-bg: linear-gradient(180deg,#ffffff,#fbfdff);
      --glass-blur: 10px;
      --glass-border: rgba(255,255,255,0.35);
      --radius: 12px;
      --transition-fast: 180ms;
      --transition-medium: 300ms;
      --transition-slow: 420ms;
      --shadow-1: 0 6px 18px rgba(30,50,100,0.06);
      --shadow-2: 0 14px 40px rgba(16,24,40,0.09);
      --logo-size: 48px;
      --content-width: 1100px;
      --glass-accent: rgba(101,196,102,0.12);

      /* motion tokens */
      --motion-pop-duration: 420ms;
      --motion-pop-ease: cubic-bezier(.12,.9,.28,1);
      --modal-duration: 260ms;
      --stagger-gap: 80ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, "Segoe UI", Roboto, Arial, system-ui;
      background: linear-gradient(180deg,var(--bg), #eef5f9 120%);
      color:#0b1220;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.35;
      transition: background var(--transition-medium) ease;
    }

    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}

    /* block scroll when modal opened */
    body.modal-open{ overflow:hidden; touch-action:none; }

    /* =========================
       header
       ========================= */
    header{
      position:sticky;
      top:0;
      z-index:60;
      display:flex;
      align-items:center;
      gap:14px;
      padding:14px 20px;
      width:100%;
      backdrop-filter: blur(10px) saturate(120%);
      background: linear-gradient(90deg, rgba(255,255,255,0.6), rgba(245,250,250,0.7));
      border-bottom: 1px solid rgba(224,238,252,0.7);
      box-shadow: 0 6px 18px rgba(16,24,40,0.04);
      transition: box-shadow 240ms ease, transform 300ms ease;
    }
    .container{
      width:100%;
      max-width:var(--content-width);
      margin:0 auto;
      padding:0 18px;
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .header-left{display:flex;align-items:center;gap:12px}
    .logo{height:var(--logo-size);width:auto;border-radius:8px;box-shadow:0 8px 26px rgba(16,24,40,0.08);transition:transform .22s ease, box-shadow .22s ease; background:transparent}
    .logo:hover{transform:translateY(-4px) scale(1.02); box-shadow: 0 20px 44px rgba(16,24,40,0.12)}
    header h1{font-size:16px;margin:0;font-weight:700;color:#0b1220;letter-spacing: -0.01em}
    header .subtitle{font-size:13px;color:var(--muted);opacity:0.95}

    /* header controls */
    .header-actions{display:flex;align-items:center;gap:8px;margin-left:auto}
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      background:linear-gradient(180deg,var(--accent),var(--accent-600));
      color:#fff;
      box-shadow: 0 10px 30px rgba(14,58,20,0.08);
      transition:transform var(--transition-fast), filter var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast);
      font-weight:700;
      font-size:14px;
      letter-spacing:0.01em;
    }
    .btn.ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid rgba(214,227,255,0.9);
      box-shadow:none;
      font-weight:700;
    }
    .btn:active{ transform:translateY(1px) }
    .btn:hover{ transform:translateY(-3px); filter:brightness(.97) }
    .icon-gear{ width:18px;height:18px; display:inline-block; opacity:.95; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.06)); }

    /* FAB style for Add button on smaller screens */
    @media (max-width:980px){
      #btnNewEvent { position: fixed; right: 18px; bottom: 88px; z-index:1200; border-radius:16px; padding:12px 16px; box-shadow:0 18px 40px rgba(16,24,40,0.12) }
    }

    /* small pill for status */
    .pill{
      padding:6px 10px;border-radius:999px;background:rgba(var(--accent-rgba),0.12); color:var(--accent);
      font-weight:700;font-size:13px;border:1px solid rgba(var(--accent-rgba),0.12);
      transition:transform var(--transition-fast), background var(--transition-fast);
    }

    /* =========================
       main layout
       ========================= */
    main.app{
      max-width:var(--content-width);
      margin:18px auto;
      padding:0 18px 60px;
    }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:12px;
    }
    .search, select, .small-input{
      padding:12px 14px;border-radius:12px;border:1px solid rgba(216,228,255,0.9);
      background:rgba(255,255,255,0.9); min-width:200px;
      transition:box-shadow var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast);
      font-size:14px;
    }
    .search:focus, select:focus{ box-shadow:0 10px 40px rgba(16,24,40,0.06); transform:translateY(-2px); border-color: rgba(var(--accent-rgba),0.18) }

    .grid{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:18px;
      align-items:start;
    }

    /* panel / glass */
    .panel{
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: var(--shadow-1);
      border:1px solid rgba(230,240,255,0.8);
      position:relative;
      overflow:visible;
      transition:box-shadow var(--transition-medium), transform var(--transition-medium), opacity var(--transition-medium);
    }
    .liquid-glass{
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.48));
      backdrop-filter: blur(var(--glass-blur)) saturate(122%);
      border:1px solid var(--glass-border);
      border-radius:var(--radius);
      overflow:hidden;
    }
    .liquid-glass.accent{ box-shadow: 0 14px 40px rgba(74,166,74,0.06); border-color: rgba(var(--accent-rgba),0.18) }

    .panel h3{margin:0 0 10px 0;font-size:15px}

    /* list & card */
    .list{display:flex;flex-direction:column;gap:12px}
    .card{
      display:flex;justify-content:space-between;gap:12px;padding:14px;border-radius:14px;
      background:linear-gradient(180deg,#fff,#fbfdff);
      border:1px solid rgba(230,243,255,0.9);
      transform:translateY(12px) scale(.995);opacity:0;
      transition: transform var(--motion-pop-duration) var(--motion-pop-ease), opacity var(--motion-pop-duration) ease, box-shadow 220ms ease;
      will-change:transform,opacity;
      overflow:visible;
    }
    /* support stagger via CSS variable --i set from JS (ms) */
    .card.in-view{
      transform:none; opacity:1; box-shadow: 0 18px 40px rgba(16,24,40,0.06);
      transition-delay: var(--i, 0ms);
    }
    .card:hover{ transform:translateY(-6px) scale(1.01); box-shadow:0 26px 60px rgba(16,24,40,0.08) }
    .card .meta{display:flex;flex-direction:column;gap:8px;min-width:60%}
    .card .meta strong{font-size:15px}
    .small{font-size:13px;color:var(--muted)}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .tag{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(216,230,255,0.9);
      background:linear-gradient(180deg, rgba(101,196,102,0.06), rgba(101,196,102,0.02)); color:var(--accent-600); font-weight:700;
      transition:transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .tag:hover{ transform:translateY(-2px); box-shadow: 0 8px 20px rgba(16,24,40,0.04) }

    .cta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .cta button{padding:8px 12px;border-radius:10px;font-weight:700}
    .cta .ghost{background:transparent;border:1px solid rgba(214,227,255,0.95); color:var(--accent); font-weight:700}
    .small-muted{font-size:12px;color:#9aa3b2}

    /* right column */
    .right{display:flex;flex-direction:column;gap:12px}
    .recommendation{padding:12px;border-radius:12px;border:1px dashed rgba(214,227,255,0.9);background:linear-gradient(180deg, rgba(255,255,255,0.8), rgba(250,255,250,0.6)); box-shadow:var(--shadow-1)}

    /* detail modal + admin modal (animated) */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(2,6,23,0.45); z-index:1000; display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; transition: opacity var(--modal-duration) ease;
      backdrop-filter: blur(3px);
    }
    .modal-backdrop.open{ opacity:1; pointer-events:auto; }

    .modal-panel{
      width:100%; max-width:920px; border-radius:14px; padding:18px; background:linear-gradient(180deg,#fff,#fbfdff); box-shadow: 0 30px 80px rgba(8,20,40,0.18);
      transform: translateY(8px) scale(.985); opacity:0; transition: transform var(--modal-duration) cubic-bezier(.2,.9,.3,1), opacity var(--modal-duration) ease;
      will-change: transform, opacity;
      border:1px solid rgba(230,240,255,0.9);
    }
    .modal-backdrop.open .modal-panel{ transform:none; opacity:1; }

    /* detail modal narrower */
    #detailModal .modal-panel{ max-width:820px; }

    /* settings-panel slide-in refinement (already present) */
    .settings-panel{
      transform: translateY(-6px) scale(.995);
      transition: opacity 280ms ease, transform 280ms ease;
    }
    .settings-panel.open{ transform:none; opacity:1; pointer-events:auto }

    /* toast */
    .toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{background:#111;color:#fff;padding:10px 12px;border-radius:8px;opacity:0.98;box-shadow:0 10px 30px rgba(2,6,23,0.4);}

    /* responsive */
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
      .settings-panel{right:12px;top:70px}
      .card .meta{min-width:55%}
    }

    /* respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      .card, .logo, .btn, .settings-panel, .modal-panel { transition:none!important; animation:none!important; transform:none!important; }
    }

    /* small utility for subtle separators */
    .muted-sep{height:1px;background:linear-gradient(90deg,transparent,rgba(220,230,255,0.8),transparent);margin:10px 0;border-radius:2px}

    /* =========================
       FORCED: ensure settings-panel sits in right-top with animation (overrides earlier rules)
       ========================= */
    /* ==== Форсированное позиционирование панели настроек (правый верх) ==== */
    .settings-panel{
      position: fixed !important;     /* фиксируем панель поверх всего */
      top: 78px !important;           /* место под header */
      right: 18px !important;
      width: 320px !important;
      max-width: 92vw !important;
      background: var(--card-bg) !important;
      border-radius: var(--radius) !important;
      box-shadow: var(--shadow-2) !important;
      border: 1px solid rgba(230,240,255,0.9) !important;
      padding: 12px 14px !important;
      transform: translateY(-6px) scale(.995) !important;
      opacity: 0 !important;
      pointer-events: none !important;
      transition: opacity 280ms ease, transform 280ms ease !important;
      z-index: 1200 !important;
    }

    /* когда открыта — видна и кликабельна */
    .settings-panel.open{
      transform: none !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }

    /* мобильная версия — чуть ниже и уже */
    @media (max-width:980px){
      .settings-panel{
        top: 70px !important;
        right: 12px !important;
        width: 260px !important;
      }
    }
  </style>
</head>
<body>
  <!-- svg фильтр для subtle glass -->
  <svg width="0" height="0" style="position:absolute">
    <filter id="liquidFilter">
      <feTurbulence id="turbulence" type="fractalNoise" baseFrequency="0.01 0.02" numOctaves="3" seed="3"/>
      <feDisplacementMap in="SourceGraphic" scale="10" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
  </svg>

  <header aria-label="Главная панель">
    <div class="container">
      <div class="header-left">
        <img src="./nis.png" alt="NIS" class="logo" id="siteLogo">
        <div>
          <h1>Портал мероприятий — Олимпиады, Конкурсы, Хакатоны</h1>
          <div class="subtitle">Онлайн-платформа: события, дедлайны, записи и развитие</div>
        </div>
      </div>

      <div class="header-actions">
        <div class="pill" id="countPill">Загружено</div>

        <button id="uiSettingsBtn" class="settings-btn" title="Настройки интерфейса" aria-haspopup="true" aria-expanded="false">
          <svg class="icon-gear" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09c.7 0 1.25-.4 1.51-1a1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 0 1 6.5 3.5l.06.06c.45.45 1.03.68 1.65.68.1 0 .2 0 .29-.02h.02A3 3 0 0 0 12 6.5c.7 0 1.33.2 1.86.54.1.06.2.09.29.09.62 0 1.2-.23 1.65-.68l.06-.06A2 2 0 0 1 19.4 4.1l-.06.06c-.45.45-.68 1.03-.68 1.65 0 .1.02.2.05.29.34.53.54 1.16.54 1.86 0 .7-.2 1.33-.54 1.86-.06.1-.09.2-.09.29 0 .62.23 1.2.68 1.65l.06.06z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span style="font-weight:700;color:var(--accent)">Тема</span>
        </button>

        <div style="width:8px"></div>

        <button id="adminBtn" class="btn ghost">Вход админа</button>
        <button id="btnNewEvent" class="btn">Добавить событие</button>
      </div>
    </div>
  </header>

  <main class="app" role="main">
    <section class="controls" aria-label="Элементы управления">
      <input id="search" class="search" type="text" placeholder="Поиск по названию или описанию..." aria-label="Поиск">
      <select id="filterSubject" class="small-input" aria-label="Фильтр по предметам">
        <option value="">Все предметы</option>
      </select>
      <select id="sortBy" class="small-input" aria-label="Сортировка">
        <option value="date">Дата (по возрастанию)</option>
        <option value="deadline">Скорый дедлайн</option>
        <option value="pop">Популярность</option>
      </select>

      <button id="btnClear" class="btn ghost">Сброс</button>
      <div style="flex:1"></div>
      <div class="small" style="color:var(--muted)">Автоматизация: импорт CSV/JSON • подсказки</div>
    </section>

    <div class="grid" aria-live="polite">
      <div>
        <div class="panel liquid-glass">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div style="display:flex;flex-direction:column">
              <div style="display:flex;gap:8px;align-items:center">
                <strong id="countLabel" style="font-size:18px">0</strong>
                <div class="small" style="color:var(--muted)">мероприятий</div>
              </div>
            </div>
            <div class="small">Поиск • Рекомендации • Запись</div>
          </div>

          <div id="list" class="list" style="margin-top:12px">
            <!-- events injected here -->
          </div>
        </div>

        <div class="panel liquid-glass" style="margin-top:14px">
          <h3>Поиск по дате</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <input id="dateFrom" type="date" class="small-input"> 
            <input id="dateTo" type="date" class="small-input">
            <button id="btnFilterDate" class="btn ghost">Применить</button>
          </div>
        </div>
      </div>

      <aside class="right" aria-label="Правая колонка">
        <div class="panel liquid-glass">
          <h3>Рекомендации</h3>
          <div>
            <label class="small">Предметная область</label>
            <select id="recSubject" class="small-input" style="margin-top:6px">
              <option value="">(без выбора)</option>
            </select>
          </div>
          <div id="recs" style="margin-top:10px"></div>
        </div>

        <div class="panel liquid-glass">
          <h3>Мои записи</h3>
          <div id="myRegs" class="small" style="min-height:46px"></div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Admin modal / forms (тот же функционал) -->
  <div id="modal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true" style="display:flex;align-items:center;justify-content:center;">
    <div class="modal-panel panel modal-panel" style="max-width:920px; position:relative">
      <button id="closeModal" style="position:absolute;right:12px;top:12px;background:transparent;color:var(--muted);border:none;font-size:20px">✕</button>
      <h2 id="modalTitle">Панель администратора</h2>

      <div id="adminBlock">
        <label>Имя события</label>
        <input id="e_title" type="text">
        <label>Описание</label>
        <textarea id="e_desc" rows="3"></textarea>
        <label>Предметы / Теги (через запятую)</label>
        <input id="e_tags" type="text" placeholder="математика, программирование, стартап">
        <label>Подкатегория (например: региональная / международная / школьная)</label>
        <input id="e_subcategory" type="text" placeholder="региональная">
        <label>Этапы (каждый этап с новой строки)</label>
        <textarea id="e_stages" rows="3" placeholder="1) Отборочный тур\n2) Региональный тур\n3) Финал"></textarea>
        <label>Места проведения (каждый пункт с новой строки)</label>
        <textarea id="e_locations" rows="2" placeholder="Онлайн / Алматы, Назарбаев Университет"></textarea>
        <label>Возраст участников (минимум и максимум)</label>
        <div style="display:flex;gap:8px">
          <input id="e_ageMin" type="number" placeholder="мин" min="0" style="width:80px">
          <input id="e_ageMax" type="number" placeholder="макс" min="0" style="width:80px">
        </div>
        <label>Количество человек в команде (мин — макс)</label>
        <div style="display:flex;gap:8px">
          <input id="e_teamMin" type="number" placeholder="мин" min="1" style="width:80px">
          <input id="e_teamMax" type="number" placeholder="макс" min="1" style="width:80px">
        </div>
        <label>Сроки проведения (дата) и дедлайн регистрации</label>
        <input id="e_date" type="date">
        <input id="e_deadline" type="datetime-local">
        <label>Финансовые вопросы (взносы, возмещение дорожных расходов и т.д.)</label>
        <textarea id="e_finance" rows="2" placeholder="Стартовый взнос: 5000 KZT. Проживание за счёт организаторов."></textarea>
        <label>Награды и перспективы</label>
        <textarea id="e_awards" rows="2" placeholder="Призовой фонд, гранты, приглашение на стажировки"></textarea>
        <label>Ссылка</label>
        <input id="e_link" type="text">

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="saveEvent" class="btn">Сохранить</button>
          <button id="importCSV" class="btn ghost">Импорт CSV</button>
          <input id="csvFile" type="file" accept="text/csv" style="display:none">
          <button id="sampleGen" class="btn ghost">Сгенерировать образцы</button>
          <button id="adminLogout" class="btn ghost">Выйти</button>
        </div>

        <div style="margin-top:8px">
          <label>Импорт/Вставка JSON (массив объектов)</label>
          <textarea id="jsonImport" rows="4" placeholder='[{"title":"...","date":"2026-05-01","deadline":"2026-04-30T23:59","tags":"математика","stages":"...","locations":"...","ageMin":14,"ageMax":18,"teamMin":1,"teamMax":3,"finance":"...","awards":"..."}]'></textarea>
          <div style="display:flex;gap:8px;margin-top:6px"><button id="btnImportJson" class="btn ghost">Импортировать JSON</button></div>
        </div>

      </div>

      <div style="margin-top:12px">
        <h4>Список событий (админ)</h4>
        <div id="adminEventList"></div>
      </div>
    </div>
  </div>

  <!-- Detail modal -->
  <div id="detailModal" class="modal-backdrop" aria-hidden="true" style="display:flex;align-items:center;justify-content:center;">
    <div class="modal-panel panel" style="max-width:820px; position:relative">
      <button id="closeDetail" style="position:absolute;right:24px;top:20px;background:transparent;border:none;font-size:20px;color:var(--muted)">✕</button>
      <div id="detailContent"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="detailRegBtn" class="btn">Записаться</button>
        <a id="detailLink" href="#" target="_blank" rel="noopener" class="btn ghost" style="text-decoration:none;padding:8px 12px;border-radius:10px;border:1px solid rgba(214,227,255,0.95);color:var(--accent)">Официальная страница</a>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toasts" aria-live="polite"></div>

  <!-- settings floating panel -->
  <div id="settingsPanel" class="settings-panel" role="dialog" aria-label="Настройки интерфейса" aria-hidden="true">
    <h4>Настройки интерфейса</h4>
    <div class="row">
      <div style="flex:1">
        <label class="small">Акцентный цвет</label>
        <input id="accentColorInput" type="color" value="#65c466" style="width:100%;height:42px;border-radius:8px;border:none;padding:0;margin-top:8px">
      </div>
    </div>

    <div class="row">
      <div style="flex:1">
        <label class="small">Пресеты</label>
        <div style="margin-top:8px">
          <span class="preset-swatch" data-color="#65c466" style="background:#65c466"></span>
          <span class="preset-swatch" data-color="#4bb543" style="background:#4bb543"></span>
          <span class="preset-swatch" data-color="#2bb673" style="background:#2bb673"></span>
          <span class="preset-swatch" data-color="#3fb37f" style="background:#3fb37f"></span>
        </div>
      </div>
    </div>

    <div class="row">
      <div style="flex:1">
        <label class="small">Интенсивность glass</label>
        <input id="glassRange" type="range" min="4" max="24" value="10" style="width:100%">
      </div>
    </div>

    <div class="row" style="margin-top:8px;align-items:center">
      <button id="resetTheme" class="btn ghost" style="flex:1">Сбросить</button>
      <button id="saveTheme" class="btn" style="flex:1">Сохранить</button>
    </div>
  </div>

  <script>
    /* =========================
       Core existing script (untouched logic)
       (I kept all original functions intact; only enhanced behavior for animations & modals)
       ========================= */

    //indexedDB 
    const DB_NAME = 'events_portal_v1';
    const STORE_EVENTS = 'events';
    const STORE_REGS = 'registrations';

    function openDB(){
      return new Promise((resolve, reject)=>{
        const r = indexedDB.open(DB_NAME, 1);
        r.onupgradeneeded = e =>{
          const db = e.target.result;
          if(!db.objectStoreNames.contains(STORE_EVENTS)){
            const s = db.createObjectStore(STORE_EVENTS, {keyPath:'id'});
            s.createIndex('date','date',{unique:false});
            s.createIndex('deadline','deadline',{unique:false});
            s.createIndex('tags','tags',{unique:false,multiEntry:true});
          }
          if(!db.objectStoreNames.contains(STORE_REGS)){
            db.createObjectStore(STORE_REGS,{keyPath:'rid',autoIncrement:true});
          }
        };
        r.onsuccess = ()=>resolve(r.result);
        r.onerror = ()=>reject(r.error);
      });
    }

    async function withStore(storeName, mode, fn){
      const db = await openDB();
      return new Promise((res,rej)=>{
        const tx = db.transaction(storeName,mode);
        const store = tx.objectStore(storeName);
        const result = fn(store);
        tx.oncomplete = ()=>res(result);
        tx.onerror = ()=>rej(tx.error);
      });
    }

    async function addEventObj(ev){
      ev.id = ev.id || crypto.randomUUID();
      await withStore(STORE_EVENTS,'readwrite',s=>s.put(ev));
      return ev.id;
    }
    async function getAllEvents(){
      const db = await openDB();
      return new Promise((res,rej)=>{
        const tx = db.transaction(STORE_EVENTS,'readonly');
        const s = tx.objectStore(STORE_EVENTS);
        const all = s.getAll();
        all.onsuccess = ()=>res(all.result || []);
        all.onerror = ()=>rej(all.error);
      });
    }
    async function deleteEvent(id){
      await withStore(STORE_EVENTS,'readwrite',s=>s.delete(id));
    }
    async function getEvent(id){
      const db = await openDB();
      return new Promise((res,rej)=>{
        const tx = db.transaction(STORE_EVENTS,'readonly');
        const r = tx.objectStore(STORE_EVENTS).get(id);
        r.onsuccess = ()=>res(r.result);
        r.onerror = ()=>rej(r.error);
      });
    }
    async function addRegistration(reg){
      reg.created = new Date().toISOString();
      await withStore(STORE_REGS,'readwrite',s=>s.add(reg));
    }
    async function getRegsForEvent(eid){
      const db = await openDB();
      return new Promise((res,rej)=>{
        const tx = db.transaction(STORE_REGS,'readonly');
        const s = tx.objectStore(STORE_REGS);
        const items = [];
        s.openCursor().onsuccess = function(e){
          const c = e.target.result;
          if(c){ if(c.value.eventId === eid) items.push(c.value); c.continue(); } else res(items);
        }
      });
    }

    //помощники ui
    function $q(id){return document.getElementById(id)}
    function toast(msg, timeout=5000){
      const wrap = $q('toasts');
      const t = document.createElement('div'); t.className='toast'; t.textContent = msg; wrap.appendChild(t);
      setTimeout(()=>{t.remove()}, timeout);
    }

    //если данные сида пустые
    async function seedIfEmpty(){
      const all = await getAllEvents();
      if(all.length) return;
      const sample = [
        {
          title:'Республиканская олимпиада по математике',
          desc:'Участие школьников 9-11 классов. Задачи по алгебре, геометрии и комбинаторике.',
          tags:['математика'],
          subcategory:'школьная/республиканская',
          stages:['Отборочный (школьный)','Региональный','Финал'],
          locations:['Онлайн','Нур-Султан, Конференц-зал НИШ'],
          ageMin:14, ageMax:18,
          teamMin:1, teamMax:1,
          date:'2026-05-15',
          deadline:'2026-05-05T23:59',
          finance:'Участие бесплатное; компенсация проезда для финалистов по заявлению.',
          awards:'Дипломы, медали, приглашение на подготовительные курсы; возможны стипендии.',
          link:'https://example.com/math'
        },
        {
          title:'Хакатон AI Junior',
          desc:'Хакатон для начинающих в области ИИ. Разработка проекта за 48 часов.',
          tags:['программирование','искусственный интеллект'],
          subcategory:'студенческая/обучающая',
          stages:['Регистрация','Спринт 48ч','Презентации и судейство'],
          locations:['Онлайн'],
          ageMin:15, ageMax:21,
          teamMin:1, teamMax:4,
          date:'2026-06-10',
          deadline:'2026-06-01T23:59',
          finance:'Стартовый взнос: 2000 KZT; призовой фонд покрывает расходы команд-победителей.',
          awards:'Призы, наставничество от индустрии, приглашения на стажировки.',
          link:'https://example.com/ai'
        },
        {
          title:'Startup Weekend — Алматы',
          desc:'Соревнования стартапов за 48 часов: от идеи до MVP и питчинга инвесторам.',
          tags:['стартап','предпринимательство'],
          subcategory:'предпринимательская/интенсив',
          stages:['Формирование команд','Разработка','Питчинг перед жюри'],
          locations:['Алматы, TechHub'],
          ageMin:16, ageMax:35,
          teamMin:2, teamMax:6,
          date:'2026-04-20',
          deadline:'2026-04-10T23:59',
          finance:'Взнос 10000 KZT; частичный фандрайзинг для победителей.',
          awards:'Пожизненные менторские сессии, призовой фонд, доступ к акселератору.',
          link:'https://example.com/startup'
        },
      ];
      for(const s of sample) await addEventObj(s);
    }

    //рендерим список — улучшено: поддержка stagger (через CSS-переменную --i)
    async function refreshList(){
      const raw = await getAllEvents();
      let events = raw.slice();
      const q = $q('search').value.trim().toLowerCase();
      const subj = $q('filterSubject').value;
      // поиск
      if(q){
        events = events.filter(e=>
          (e.title||'').toLowerCase().includes(q) ||
          (e.desc||'').toLowerCase().includes(q) ||
          (e.tags||[]).join(' ').toLowerCase().includes(q) ||
          (e.subcategory||'').toLowerCase().includes(q) ||
          (e.stages||[]).join(' ').toLowerCase().includes(q) ||
          (e.locations||[]).join(' ').toLowerCase().includes(q)
        );
      }
      if(subj){ events = events.filter(e=> (e.tags||[]).includes(subj) || (e.subcategory||'')===subj ); }
      // фильтр по дат
      const df = $q('dateFrom').value, dt = $q('dateTo').value;
      if(df){ events = events.filter(e=> e.date >= df); }
      if(dt){ events = events.filter(e=> e.date <= dt); }
      // сорт
      const sortBy = $q('sortBy').value;
      if(sortBy==='date') events.sort((a,b)=> (a.date||'') > (b.date||'')?1:-1);
      if(sortBy==='deadline') events.sort((a,b)=> (a.deadline||'') > (b.deadline||'')?1:-1);
      if(sortBy==='pop') events.sort((a,b)=> (getRegsCountSync(b.id) || 0) - (getRegsCountSync(a.id) || 0));

      $q('list').innerHTML='';
      $q('countLabel').textContent = events.length;

      // use index to support staggered animation
      for(let idx=0; idx<events.length; idx++){
        const e = events[idx];
        const card = document.createElement('div'); card.className='card';
        // set stagger delay (CSS var)
        const delayMs = idx * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--stagger-gap')||'80');
        card.style.setProperty('--i', `${delayMs}ms`);

        const left = document.createElement('div'); left.className='meta';
        const md = document.createElement('div');
        // краткая сводка: название, дата, дедлайн, подкатегория
        md.innerHTML = `<div style="font-weight:600">${escapeHtml(e.title||'Без названия')}</div>
                        <div class="small">${formatDate(e.date)} • дедлайн: ${formatDateTime(e.deadline)} • ${escapeHtml(e.subcategory||'')}</div>
                        <div class="small">${escapeHtml(e.desc||'')}</div>`;
        left.appendChild(md);

        // дополнительные краткие метрики (возраст, команда, награды кратко)
        const extras = document.createElement('div');
        extras.className='small';
        const ageText = (e.ageMin || e.ageMax) ? `Возраст: ${e.ageMin||'-'}–${e.ageMax||'-'}` : '';
        const teamText = (e.teamMin || e.teamMax) ? `Команда: ${e.teamMin||'-'}–${e.teamMax||'-'}` : '';
        const awardText = e.awards ? (`Награды: ${e.awards.split('.').slice(0,1).join('.')}`) : '';
        extras.textContent = [ageText, teamText, awardText].filter(Boolean).join(' • ');
        left.appendChild(extras);

        const tags = document.createElement('div'); tags.className='tags';
        (e.tags||[]).slice(0,4).forEach(t=>{const sp=document.createElement('span');sp.className='tag';sp.textContent=t;tags.appendChild(sp)});
        left.appendChild(tags);

        const right = document.createElement('div'); right.style.textAlign='right';
        const regCount = getRegsCountSync(e.id) || 0;
        const btnReg = document.createElement('button'); btnReg.textContent='Записаться';
        btnReg.className='btn';
        btnReg.onclick = ()=>openRegForm(e);
        const btnMore = document.createElement('button'); btnMore.className='ghost'; btnMore.textContent='Подробнее'; btnMore.onclick = ()=>openDetail(e.id);
        right.appendChild(document.createElement('div')).style.height='6px';
        right.appendChild(document.createElement('div'));
        const cBlock = document.createElement('div'); cBlock.className='cta';
        cBlock.appendChild(btnReg); cBlock.appendChild(btnMore);
        const pop = document.createElement('div'); pop.className='small'; pop.textContent = `Участников: ${regCount}`;
        right.appendChild(pop); right.appendChild(cBlock);

        card.appendChild(left); card.appendChild(right);
        $q('list').appendChild(card);
      }
      await refreshAdminList();
      refreshSubjects(raw);
      refreshMyRegs();
      calcDeadlineHints(raw);

      // observe cards for entrance animation
      observeCards();
    }

    function escapeHtml(s){ return (s+'').replace(/[&<>]/g,ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[ch])); }
    function formatDate(d){ if(!d) return '-'; return (new Date(d)).toLocaleDateString(); }
    function formatDateTime(d){ if(!d) return '-'; return (new Date(d)).toLocaleString(); }

    //помощники для маленького интерфейса фор ексампл для подсчета кэша
    let regsCache = {}; // eventId -> count
    async function rebuildRegsCache(){
      regsCache = {};
      const db = await openDB();
      return new Promise((res)=>{
        const tx = db.transaction(STORE_REGS,'readonly');
        tx.objectStore(STORE_REGS).openCursor().onsuccess = e=>{
          const c = e.target.result; if(c){ regsCache[c.value.eventId] = (regsCache[c.value.eventId]||0) + 1; c.continue(); } else res();
        }
      });
    }
    function getRegsCountSync(eid){ return regsCache[eid] || 0; }

    //функции админа
    let editingId = null;
    document.getElementById('adminBtn').addEventListener('click', ()=>promptAdminLogin());
    document.getElementById('btnNewEvent').addEventListener('click', ()=>{ promptAdminLogin(()=>openModal()); });

    function promptAdminLogin(cb){
      const pass = prompt('Введите пароль администратора (по умолчанию: admin)');
      if(pass === null) return; // cancel
      if(pass === 'admin'){ localStorage.setItem('isAdmin','1'); toast('Вход как админ успешен'); if(cb) cb(); else openModal(); }
      else alert('Неверный пароль');
    }

    // original simple open/close replaced below with animated versions
    function openModal(){ $q('modal').style.display='flex'; }
    function closeModal(){ $q('modal').style.display='none'; editingId = null; fillAdminFormEmpty(); }
    $q('closeModal').addEventListener('click', ()=>{ closeModal(); });

    function fillAdminFormEmpty(){
      $q('modalTitle').textContent='Панель администратора';
      $q('e_title').value=''; $q('e_desc').value=''; $q('e_tags').value=''; $q('e_subcategory').value='';
      $q('e_stages').value=''; $q('e_locations').value=''; $q('e_ageMin').value=''; $q('e_ageMax').value='';
      $q('e_teamMin').value=''; $q('e_teamMax').value=''; $q('e_date').value=''; $q('e_deadline').value=''; $q('e_finance').value=''; $q('e_awards').value=''; $q('e_link').value='';
    }

    $q('saveEvent').addEventListener('click', async ()=>{
      if(!localStorage.getItem('isAdmin')) return alert('Только админ');
      const obj = {
        title:$q('e_title').value.trim(),
        desc:$q('e_desc').value.trim(),
        tags:($q('e_tags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
        subcategory:($q('e_subcategory').value||'').trim(),
        stages:($q('e_stages').value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean),
        locations:($q('e_locations').value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean),
        ageMin: $q('e_ageMin').value ? Number($q('e_ageMin').value) : undefined,
        ageMax: $q('e_ageMax').value ? Number($q('e_ageMax').value) : undefined,
        teamMin: $q('e_teamMin').value ? Number($q('e_teamMin').value) : undefined,
        teamMax: $q('e_teamMax').value ? Number($q('e_teamMax').value) : undefined,
        date:$q('e_date').value,
        deadline:$q('e_deadline').value,
        finance:$q('e_finance').value.trim(),
        awards:$q('e_awards').value.trim(),
        link:$q('e_link').value.trim()
      };
      if(!obj.title) return alert('Введите название');
      if(editingId){ obj.id = editingId; await addEventObj(obj); toast('Событие обновлено'); }
      else{ await addEventObj(obj); toast('Событие добавлено'); }
      await rebuildRegsCache();
      await refreshList();
      closeModal();
    });

    $q('adminLogout').addEventListener('click', ()=>{ localStorage.removeItem('isAdmin'); toast('Вы вышли как админ'); closeModal(); });

    async function refreshAdminList(){
      const all = await getAllEvents();
      const wrap = $q('adminEventList'); wrap.innerHTML='';
      all.forEach(e=>{
        const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.padding='6px 0';
        el.innerHTML = `<div><strong>${escapeHtml(e.title)}</strong> <div class="small">${(e.tags||[]).join(', ')} • ${escapeHtml(e.subcategory||'')}</div></div>`;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px';
        const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent='Изменить'; edit.onclick = ()=>{ editingId = e.id; openModal(); fillFormForEdit(e); };
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Удалить'; del.onclick = async ()=>{ if(confirm('Удалить?')){ await deleteEvent(e.id); toast('Удалено'); await rebuildRegsCache(); await refreshList(); } };
        controls.appendChild(edit); controls.appendChild(del);
        el.appendChild(controls); wrap.appendChild(el);
      });
    }

    function fillFormForEdit(e){
      $q('modalTitle').textContent='Редактирование события';
      $q('e_title').value = e.title || '';
      $q('e_desc').value = e.desc||'';
      $q('e_tags').value = (e.tags||[]).join(', ');
      $q('e_subcategory').value = e.subcategory || '';
      $q('e_stages').value = (e.stages||[]).join('\n');
      $q('e_locations').value = (e.locations||[]).join('\n');
      $q('e_ageMin').value = e.ageMin || '';
      $q('e_ageMax').value = e.ageMax || '';
      $q('e_teamMin').value = e.teamMin || '';
      $q('e_teamMax').value = e.teamMax || '';
      $q('e_date').value = e.date||'';
      $q('e_deadline').value = e.deadline||'';
      $q('e_finance').value = e.finance||'';
      $q('e_awards').value = e.awards||'';
      $q('e_link').value = e.link||'';
    }

    //импорт сисиви
    $q('importCSV').addEventListener('click', ()=>$q('csvFile').click());
    $q('csvFile').addEventListener('change', async function(){
      const f = this.files[0]; if(!f) return; const txt = await f.text(); importFromCSV(txt);
    });
    function parseCSV(text){
      // простой state-machine парсер CSV, понимает кавычки и запятые внутри них
      const rows = [];
      let cur = '';
      let row = [];
      let inQuotes = false;
      for (let i = 0; i < text.length; i++){
        const ch = text[i];
        const nxt = text[i+1];
        if (ch === '"') {
          // двойные двойные кавычки внутри поля -> экранирование
          if (inQuotes && nxt === '"') { cur += '"'; i++; continue; }
          inQuotes = !inQuotes;
          continue;
        }
        if (ch === ',' && !inQuotes) {
          row.push(cur);
          cur = '';
          continue;
        }
        if ((ch === '\n' || (ch === '\r' && nxt === '\n')) && !inQuotes) {
          if (ch === '\r' && nxt === '\n') i++;
          row.push(cur);
          rows.push(row);
          row = [];
          cur = '';
          continue;
        }
        cur += ch;
      }
      // остаток
      if (cur !== '' || row.length) {
        row.push(cur);
        rows.push(row);
      }
      // очистка: обрезаем пробелы и убираем обрамляющие кавычки
      return rows.map(r => r.map(cell => {
        if (cell == null) return '';
        let s = cell.toString().trim();
        if (s.startsWith('"') && s.endsWith('"')) s = s.slice(1, -1);
        return s;
      }));
    }

    async function importFromCSV(txt){
      try{
        if(!txt || !txt.trim()) { toast('файл пустой'); return; }
        const parsed = parseCSV(txt);
        if(parsed.length < 1){ toast('не удалось распарсить csv'); return; }

        // первая строка — заголовки
        const headers = parsed[0].map(h=> (h||'').trim() );
        const dataRows = parsed.slice(1).filter(r => r.join('').trim().length > 0);

        if(dataRows.length === 0){ toast('нет строк с данными в csv'); return; }

        // создаём объекты
        for(const cols of dataRows){
          const rowObj = {};
          headers.forEach((h, i) => { rowObj[h] = (cols[i] ?? '').trim(); });

          const obj = {
            title: rowObj.title || rowObj.name || '',
            desc: rowObj.desc || rowObj.description || '',
            tags: (rowObj.tags || '').toString().replace(/;/g,',').split(',').map(s=>s.trim()).filter(Boolean),
            subcategory: rowObj.subcategory || '',
            stages: (rowObj.stages || rowObj.stage || '').toString().split(/;|\n/).map(s=>s.trim()).filter(Boolean),
            locations: (rowObj.locations || rowObj.location || '').toString().split(/;|\n/).map(s=>s.trim()).filter(Boolean),
            ageMin: rowObj.ageMin ? Number(rowObj.ageMin) : undefined,
            ageMax: rowObj.ageMax ? Number(rowObj.ageMax) : undefined,
            teamMin: rowObj.teamMin ? Number(rowObj.teamMin) : undefined,
            teamMax: rowObj.teamMax ? Number(rowObj.teamMax) : undefined,
            date: rowObj.date || '',
            deadline: rowObj.deadline || '',
            finance: rowObj.finance || '',
            awards: rowObj.awards || '',
            link: rowObj.link || ''
          };

          // минимальная валидация, чтобы не добавлять пустые события
          if(!obj.title && !obj.desc) continue;
          await addEventObj(obj);
        }

        toast('csv импортирован (проверьте админ-панель)');
        await rebuildRegsCache();
        await refreshList();
      }catch(err){
        console.error('importFromCSV error', err);
        alert('ошибка при импорте csv: ' + (err && err.message ? err.message : 'unknown'));
      }
    }

    $q('btnImportJson').addEventListener('click', ()=>{

      try{
        const arr = JSON.parse($q('jsonImport').value);
        if(!Array.isArray(arr)) throw 0;
        arr.forEach(async it=>{
          const o = {
            title:it.title||it.name,
            desc:it.desc||it.description,
            tags:(it.tags||'').toString().split(',').map(s=>s.trim()).filter(Boolean),
            subcategory: it.subcategory||'',
            stages: (it.stages || '').toString().split(/;|\\n/).map(s=>s.trim()).filter(Boolean),
            locations: (it.locations || '').toString().split(/;|\\n/).map(s=>s.trim()).filter(Boolean),
            ageMin: it.ageMin? Number(it.ageMin): undefined,
            ageMax: it.ageMax? Number(it.ageMax): undefined,
            teamMin: it.teamMin? Number(it.teamMin): undefined,
            teamMax: it.teamMax? Number(it.teamMax): undefined,
            date:it.date,
            deadline:it.deadline,
            finance:it.finance||'',
            awards:it.awards||'',
            link:it.link
          };
          await addEventObj(o);
        });
        toast('JSON импортирован');
        rebuildRegsCache().then(refreshList);
      }catch(e){ alert('Ошибка JSON'); }
    });

    $q('sampleGen').addEventListener('click', async ()=>{ if(!confirm('Добавить 5 тестовых событий?')) return; for(let i=0;i<5;i++){ await addEventObj({title:`Тестовое событие ${i+1}`,desc:'Сгенерировано',tags:['тест','обучение'],subcategory:'тест',stages:['Тестовый этап 1','Тестовый этап 2'],locations:['Онлайн'],ageMin:12,ageMax:20,teamMin:1,teamMax:4,date:`2026-0${(i%9)+1}-1${i}`,deadline:`2026-0${(i%9)+1}-0${(i+1)}T23:59`,finance:'Бесплатно',awards:'Диплом',link:''}); } toast('Сгенерированы тестовые события'); rebuildRegsCache().then(refreshList); });

    //рега пользователей
    function openRegForm(eventObj){
      const name = prompt('Ваше имя'); if(!name) return;
      const email = prompt('Email для связи'); if(!email) return;
      // сохраняем контакт и eventId
      addRegistration({eventId:eventObj.id,name, email}).then(()=>{ toast('Вы успешно записаны'); rebuildRegsCache().then(refreshList); });
    }

    //подробности: теперь показывает детальную модалку с полными полями
    async function openDetail(id){
      const e = await getEvent(id);
      if(!e) return alert('Не найдено');

      const content = [];
      content.push(`<h2>${escapeHtml(e.title)}</h2>`);
      content.push(`<div class="small">${escapeHtml(e.subcategory||'')}</div>`);
      content.push(`<p>${escapeHtml(e.desc||'')}</p>`);
      content.push(`<div><strong>Дата мероприятия:</strong> ${formatDate(e.date)} • <strong>Дедлайн регистрации:</strong> ${formatDateTime(e.deadline)}</div>`);

      if(e.stages && e.stages.length){
        content.push('<div style="margin-top:8px"><strong>Этапы:</strong><ol>');
        e.stages.forEach(s=> content.push(`<li>${escapeHtml(s)}</li>`));
        content.push('</ol></div>');
      }
      if(e.locations && e.locations.length){
        content.push('<div style="margin-top:8px"><strong>Места проведения:</strong><ul>');
        e.locations.forEach(l=> content.push(`<li>${escapeHtml(l)}</li>`));
        content.push('</ul></div>');
      }

      const age = (e.ageMin || e.ageMax) ? `<strong>Возраст участников:</strong> ${e.ageMin||'-'} — ${e.ageMax||'-'}` : '';
      const team = (e.teamMin || e.teamMax) ? `<strong>Команда:</strong> ${e.teamMin||'-'} — ${e.teamMax||'-'}` : '';
      if(age || team) content.push(`<div style="margin-top:8px">${age} ${age && team ? ' • ':''} ${team}</div>`);

      if(e.finance) content.push(`<div style="margin-top:8px"><strong>Финансовые вопросы:</strong><div class="small">${escapeHtml(e.finance)}</div></div>`);
      if(e.awards) content.push(`<div style="margin-top:8px"><strong>Награды и перспективы:</strong><div class="small">${escapeHtml(e.awards)}</div></div>`);

      if(e.tags && e.tags.length) content.push(`<div style="margin-top:8px" class="small"><strong>Теги:</strong> ${escapeHtml((e.tags||[]).join(', '))}</div>`);

      $q('detailContent').innerHTML = content.join('');
      $q('detailLink').href = e.link || '#';
      $q('detailRegBtn').onclick = ()=>{ closeDetail(); openRegForm(e); };

      // animated open
      openDetailModal();
      // прокрутка наверх
      $q('detailModal').scrollTop = 0;
    }

    function closeDetail(){ /* replaced below by animated version */ }
    $q('closeDetail').addEventListener('click', ()=>{ closeDetail(); });

    //предметные олимпиады и реки 
    function refreshSubjects(events){
      const set = new Set();
      events.forEach(e=>{
        (e.tags||[]).forEach(t=>set.add(t));
        if(e.subcategory) set.add(e.subcategory);
      });
      const arr = Array.from(set).sort();
      const fs = $q('filterSubject'); const rs = $q('recSubject'); fs.innerHTML='<option value="">Все предметы</option>'; rs.innerHTML='<option value="">(без выбора)</option>';
      arr.forEach(a=>{ const op = document.createElement('option'); op.value=a; op.textContent=a; fs.appendChild(op); const op2 = op.cloneNode(true); rs.appendChild(op2); });
    }

    $q('recSubject').addEventListener('change', async ()=>{ const s = $q('recSubject').value; const all = await getAllEvents(); const recs = recommend(all,s); renderRecs(recs); });

    function recommend(events, subject){
      // простая система рекомендаций: если выбрана предметная область — отобрать по тегам или подкатегории; иначе ранжировать по ближайшему дедлайну и популярности
      let arr = events.slice();
      if(subject){ arr = arr.filter(e=> (e.tags||[]).includes(subject) || (e.subcategory||'')===subject); }
      arr.forEach(e=>{ const days = daysUntil(e.deadline); e._score = (subject?10:0) + (e.tags? e.tags.length:0) - (days===null?0:days/30) + (getRegsCountSync(e.id)||0); });
      arr.sort((a,b)=> (b._score||0) - (a._score||0));
      return arr.slice(0,5);
    }
    function renderRecs(list){ const w = $q('recs'); w.innerHTML=''; if(!list.length){ w.textContent='Нет рекомендаций'; return; } list.forEach(e=>{ const d = document.createElement('div'); d.className='recommendation'; d.innerHTML = `<strong>${escapeHtml(e.title)}</strong><div class="small">${escapeHtml((e.tags||[]).join(', '))} • ${escapeHtml(e.subcategory||'')} • дедлайн: ${formatDateTime(e.deadline)}</div><div style="margin-top:6px"><button onclick="openDetail('${e.id}')" class="btn">Подробнее</button> <button onclick="openRegForm(${JSON.stringify(e).replaceAll("'","\'")})" class="btn ghost">Записаться</button></div>`; w.appendChild(d); }); }

    //Подсказки по дедлайнам
    function daysUntil(iso){ if(!iso) return null; const d = new Date(iso); const now = new Date(); const diff = (d - now)/(1000*3600*24); return Math.floor(diff); }
    function calcDeadlineHints(events){
      events.forEach(e=>{
        const days = daysUntil(e.deadline);
        if(days !== null && days <=7 && days >=0){ toast(`Внимание: дедлайн для "${e.title}" через ${days} дн.`); }
      });
      // попросим разрешение на нативные уведомления (одноразово)
      if(Notification && Notification.permission === 'default'){
        Notification.requestPermission().then(p=>{ if(p==='granted'){ /* nothing */ } });
      }
      // отправка нотификаций для ближайшего
      const nearest = events.filter(e=>daysUntil(e.deadline) !== null && daysUntil(e.deadline) <=7 && daysUntil(e.deadline) >=0).sort((a,b)=>daysUntil(a.deadline)-daysUntil(b.deadline))[0];
      if(nearest && Notification && Notification.permission === 'granted'){
        new Notification('Скорый дедлайн', {body:`${nearest.title} — дедлайн ${formatDateTime(nearest.deadline)}`});
      }
    }

    // записи
    async function refreshMyRegs(){
      const wrap = $q('myRegs'); wrap.innerHTML='';
      const db = await openDB(); const arr=[];
      await new Promise(res=>{
        db.transaction(STORE_REGS,'readonly').objectStore(STORE_REGS).openCursor().onsuccess = e=>{
          const c=e.target.result; if(c){ arr.push(c.value); c.continue(); } else res(); }
      });
      if(!arr.length) { wrap.textContent='У вас нет записей'; return; }
      for(const r of arr){
        const ev = await getEvent(r.eventId);
        const el = document.createElement('div'); el.style.padding='6px 0';
        el.innerHTML = `<div><strong>${escapeHtml(ev?.title||'—')}</strong> <div class="small">${r.name} • ${r.email}</div></div>`;
        wrap.appendChild(el);
      }
    }

    // маленькие утилитики
    window.openDetail = openDetail; window.openRegForm = openRegForm; // для inline handlers

    // пересобрать кэш при загрузке, при необходимости врубить
    (async ()=>{
      await seedIfEmpty();
      await rebuildRegsCache();
      await refreshList();
    })();

    // найти хандлерочки
    $q('search').addEventListener('input', ()=>refreshList());
    $q('filterSubject').addEventListener('change', ()=>refreshList());
    $q('sortBy').addEventListener('change', ()=>refreshList());
    $q('btnFilterDate').addEventListener('click', ()=>refreshList());
    $q('btnClear').addEventListener('click', ()=>{ $q('search').value=''; $q('filterSubject').value=''; $q('dateFrom').value=''; $q('dateTo').value=''; refreshList(); });

    const turb = document.getElementById("turbulence");
    let t = 0;
    function animateTurbulence(){
      t += 0.0005;
      const x = 0.008 + Math.sin(t) * 0.002;
      const y = 0.015 + Math.cos(t) * 0.002;
      if(turb) turb.setAttribute("baseFrequency", `${x} ${y}`);
      requestAnimationFrame(animateTurbulence);
    }
    animateTurbulence();

    /* =========================
       UI enhancements (visual)
       - modal animated open/close
       - card stagger on entrance
       - small CSS fixes
       ========================= */

    // utility: hex -> r,g,b
    function hexToRgb(hex){
      if(!hex) return [101,196,102];
      hex = hex.replace('#','');
      if(hex.length === 3) hex = hex.split('').map(c=>c + c).join('');
      const num = parseInt(hex,16);
      return [(num>>16)&255, (num>>8)&255, num&255];
    }

    // apply accent (updates CSS vars + some inline styles)
    function applyAccent(hex, persist=true){
      const [r,g,b] = hexToRgb(hex);
      document.documentElement.style.setProperty('--accent', hex);
      document.documentElement.style.setProperty('--accent-rgba', `${r},${g},${b}`);
      // slightly darker for accent-600
      const darken = (v)=> Math.max(0, Math.round(v * 0.85));
      const accent600 = `rgb(${darken(r)}, ${darken(g)}, ${darken(b)})`;
      document.documentElement.style.setProperty('--accent-600', accent600);
      // update pills & tag backgrounds for contrast
      document.querySelectorAll('.tag').forEach(t => {
        t.style.background = `linear-gradient(180deg, rgba(${r},${g},${b},0.06), rgba(${r},${g},${b},0.02))`;
        t.style.color = accent600;
      });
      document.querySelectorAll('.btn').forEach(bn=>{
        if(!bn.classList.contains('ghost')){
          bn.style.background = `linear-gradient(180deg, ${hex}, ${accent600})`;
          bn.style.boxShadow = `0 12px 40px rgba(${r},${g},${b},0.12)`;
        } else {
          bn.style.borderColor = `rgba(${r},${g},${b},0.12)`;
          bn.style.color = hex;
        }
      });
      // header gradient subtle update
      const hdr = document.querySelectorAll('header')[0];
      if(hdr) hdr.style.background = `linear-gradient(90deg, rgba(255,255,255,0.64), rgba(${r},${g},${b},0.04))`;

      if(persist) localStorage.setItem('uiAccent', hex);
    }

    // apply glass blur intensity
    function applyGlassIntensity(val, persist=true){
      document.documentElement.style.setProperty('--glass-blur', `${val}px`);
      if(persist) localStorage.setItem('uiGlass', String(val));
    }

    // load saved theme
    (function loadSavedTheme(){
      const accent = localStorage.getItem('uiAccent');
      const glass = localStorage.getItem('uiGlass');
      if(accent) { applyAccent(accent, false); $q('accentColorInput').value = accent; }
      if(glass){ applyGlassIntensity(Number(glass), false); $q('glassRange').value = glass; }
    })();

    // settings panel interactions
    const uiBtn = $q('uiSettingsBtn');
    const sPanel = $q('settingsPanel');
    uiBtn.addEventListener('click', ()=>{
      const open = sPanel.classList.toggle('open');
      uiBtn.setAttribute('aria-expanded', String(open));
      sPanel.setAttribute('aria-hidden', open? 'false':'true');
    });

    $q('accentColorInput').addEventListener('input', (e)=>{
      applyAccent(e.target.value, false);
    });

    document.querySelectorAll('.preset-swatch').forEach(el=>{
      el.addEventListener('click', ()=>{ const c = el.getAttribute('data-color'); $q('accentColorInput').value = c; applyAccent(c, false); });
    });

    $q('glassRange').addEventListener('input', (e)=>{
      applyGlassIntensity(e.target.value, false);
    });

    $q('saveTheme').addEventListener('click', ()=>{
      localStorage.setItem('uiAccent', $q('accentColorInput').value);
      localStorage.setItem('uiGlass', $q('glassRange').value);
      toast('Тема сохранена');
    });
    $q('resetTheme').addEventListener('click', ()=>{
      localStorage.removeItem('uiAccent');
      localStorage.removeItem('uiGlass');
      applyAccent('#65c466', true);
      applyGlassIntensity(10, true);
      $q('accentColorInput').value = '#65c466';
      $q('glassRange').value = 10;
      toast('Тема сброшена');
    });

    // update the count pill with loaded number (visual)
    async function updateCountPill(){
      const all = await getAllEvents();
      $q('countPill').textContent = `${all.length} событий`;
    }
    // call periodically on major changes
    (async ()=>{ await updateCountPill(); })();

    // IntersectionObserver для плавного появления карточек (стаггер)
    let cardObserver = null;
    function observeCards(){
      const cards = document.querySelectorAll('.card');
      if(!('IntersectionObserver' in window)) { cards.forEach(c=>c.classList.add('in-view')); return; }
      if(cardObserver) cardObserver.disconnect();
      cardObserver = new IntersectionObserver((entries)=>{
        entries.forEach(ent=>{
          if(ent.isIntersecting){
            ent.target.classList.add('in-view');
            // unobserve to keep DOM light
            cardObserver.unobserve(ent.target);
          }
        });
      }, {threshold:0.12});
      cards.forEach(c=> cardObserver.observe(c));
    }

    // tweak: animate header sheen slightly on load
    (function headerPulse(){
      const h = document.querySelector('header');
      if(!h) return;
      h.animate([{transform:'translateY(0)'},{transform:'translateY(-3px)'},{transform:'translateY(0)'}], {duration:2200, iterations:1, easing:'ease-in-out'});
    })();

    // ensure dynamic updates when new data inserted
    const originalAddEventObj = addEventObj;
    addEventObj = async function(ev){
      const id = await originalAddEventObj(ev);
      await rebuildRegsCache();
      await refreshList();
      await updateCountPill();
      return id;
    };

    // small accessibility: close settings on outside click
    document.addEventListener('click', (e)=>{
      if(!sPanel.classList.contains('open')) return;
      const inside = sPanel.contains(e.target) || uiBtn.contains(e.target);
      if(!inside){ sPanel.classList.remove('open'); uiBtn.setAttribute('aria-expanded','false'); sPanel.setAttribute('aria-hidden','true') }
    });

    // sanity: ensure buttons styled right after load
    window.addEventListener('load', ()=>{ applyAccent(localStorage.getItem('uiAccent') || '#65c466', false); applyGlassIntensity(Number(localStorage.getItem('uiGlass')||10), false); });

    // update count pill when events change
    const origDeleteEvent = deleteEvent;
    deleteEvent = async function(id){
      await origDeleteEvent(id);
      await rebuildRegsCache();
      await refreshList();
      await updateCountPill();
    };

    // helper: small debounce for search to reduce re-renders on slow devices
    (function addDebounce(){
      let t;
      const src = $q('search');
      const orig = src.oninput;
      src.addEventListener('input', (e)=>{
        clearTimeout(t);
        t = setTimeout(()=> refreshList(), 180);
      });
    })();

    // expose some utils to console for debugging / quick theme switch
    window._applyAccent = applyAccent;
    window._applyGlass = applyGlassIntensity;

    /* =========================
       Animated modal open/close replacement
       (we replace earlier simple display toggles with class-based transitions)
       ========================= */

    const adminModal = $q('modal');
    const detailModalEl = $q('detailModal');

    function openModalAnimated(){
      // prepare
      adminModal.style.display = 'flex';
      // small timeout to allow style to apply then add open
      requestAnimationFrame(()=> {
        adminModal.classList.add('open');
        adminModal.querySelector('.modal-panel')?.classList.add('open');
        document.body.classList.add('modal-open');
      });
      adminModal.setAttribute('aria-hidden','false');
    }
    function closeModalAnimated(){
      adminModal.classList.remove('open');
      adminModal.querySelector('.modal-panel')?.classList.remove('open');
      adminModal.setAttribute('aria-hidden','true');
      document.body.classList.remove('modal-open');
      // after transition, hide for accessibility & pointer events
      setTimeout(()=>{ adminModal.style.display='none'; editingId = null; fillAdminFormEmpty(); }, 300);
    }

    // override previous open/close with animated ones
    openModal = openModalAnimated;
    closeModal = closeModalAnimated;

    function openDetailModal(){
      detailModalEl.style.display = 'flex';
      requestAnimationFrame(()=> {
        detailModalEl.classList.add('open');
        detailModalEl.querySelector('.modal-panel')?.classList.add('open');
        document.body.classList.add('modal-open');
      });
      detailModalEl.setAttribute('aria-hidden','false');
    }
    function closeDetailModal(){
      detailModalEl.classList.remove('open');
      detailModalEl.querySelector('.modal-panel')?.classList.remove('open');
      detailModalEl.setAttribute('aria-hidden','true');
      document.body.classList.remove('modal-open');
      setTimeout(()=>{ detailModalEl.style.display='none'; }, 300);
    }

    // override
    openDetailModal = openDetailModal;
    closeDetail = closeDetailModal;

    // hook direct close buttons
    $q('closeModal').addEventListener('click', ()=> closeModal());
    $q('closeDetail').addEventListener('click', ()=> closeDetail());

    // close modal when backdrop clicked (but not when clicking panel)
    adminModal.addEventListener('click', (ev)=>{
      if(ev.target === adminModal) closeModal();
    });
    detailModalEl.addEventListener('click', (ev)=>{
      if(ev.target === detailModalEl) closeDetail();
    });

    // keyboard: Esc to close modals
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if(adminModal.classList.contains('open')) closeModal();
        if(detailModalEl.classList.contains('open')) closeDetail();
      }
    });

    // small UX: mark settings btn aria
    uiBtn.setAttribute('aria-expanded','false');

  </script>

  <!-- =========================
       FORCE JS: переместить settingsPanel в body и поставить inline-стили (вставлено отдельно)
       ========================= -->
  <script>
    // Force-settings-panel: переместить в body и установить корректные inline-стили.
    // Выполняется после загрузки, защищает от конфликтов с другими стилями.
    (function fixSettingsPanelPosition(){
      function apply() {
        const s = document.getElementById('settingsPanel');
        if(!s) return;
        // Переместим прямо под <body> (внешне будет над контентом, справа сверху)
        if(s.parentNode !== document.body) document.body.appendChild(s);

        // Установим inline-стили (форс)
        Object.assign(s.style, {
          position: 'fixed',
          top: '78px',
          right: '18px',
          width: '320px',
          maxWidth: '92vw',
          zIndex: '1200',
          transition: 'opacity 280ms ease, transform 280ms ease',
          transform: 'translateY(-6px) scale(.995)',
          opacity: '0',
          pointerEvents: 'none',
        });

        // ensure the open class controls visibility
        s.classList.remove('open');
        // keep aria in sync
        s.setAttribute('aria-hidden','true');

        // expose helper to open programmatically if needed
        window.showSettingsPanel = ()=>{ s.classList.add('open'); s.setAttribute('aria-hidden','false'); };
        window.hideSettingsPanel = ()=>{ s.classList.remove('open'); s.setAttribute('aria-hidden','true'); };
      }

      if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', apply);
      else apply();
    })();
  </script>

  <!-- svg фильтр (дублированно внизу для надежности) -->
  <svg width="0" height="0" style="position:absolute">
    <filter id="liquidFilter" x="-20%" y="-20%" width="140%" height="140%">
      <feTurbulence id="turbulence" baseFrequency="0.01 0.02" numOctaves="3" seed="3" type="fractalNoise"/>
      <feDisplacementMap in="SourceGraphic" scale="10" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
  </svg>

<div class="credits">
  BrBrPatapim Team • Kalikhan Adil, Mamleeva Aurika, Lezhankova Safiya, Amangeldy Damir
</div>
</body>
</html>
